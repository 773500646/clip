<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title></title>
    <!--<script type="text/javascript" src="js/clip.js"></script> -->
</head> 
<body>
	<style type="text/css">
		*{margin:0;padding:0;}
        #Mi_drop{position:absolute;top:0;left:0;z-index:666;width:100%;height:100%;overflow:hidden;}
        #Mi_drop .Mi_drop_content{width:100%;height:100%;position:relative;}
        #Mi_drop .Mi_drop_content .Mi_drop_canvas{position:absolute;top:0;left:0;z-index:2;}
        #Mi_drop .Mi_drop_content .Mi_drop_bg{width:100%;height:100%;position:absolute;top:0;left:0;z-index: -1;}
        #Mi_drop .Mi_drop_btn{position:absolute;bottom:20px;width:100%;z-index:6;}
        #Mi_drop .Mi_drop_btn button{width:60px;height:30px;border:0;border-radius:3px;color:#ffffff;font-size:14px;outline-width: 0px;}
        #Mi_drop .Mi_drop_btn button:first-child{float:left;margin-left:20px;background:#f89119;}
        #Mi_drop .Mi_drop_btn button.Mi_close{float:right;margin-right:20px;background:#35b345;}
    </style>
    <div id="Mi_drop">
        <div class="Mi_drop_content">
            <canvas class="Mi_drop_canvas" id="Mi_drop_canvas" width="375" height="667">你的浏览器不支持canvas</canvas>
            <div class="Mi_drop_bg"></div>
        </div>
        <div class="Mi_drop_btn"> 
            <button class="Mi_choose">选择</button>
            <button class="Mi_close">完成</button>
            <input  class="Mi_file" type="file" accept="image/*" style="display:none;">
        </div>
    </div>
</body>
<script>
    window.onload=function(){
        var options={
            w:document.documentElement.clientWidth||document.body.clientWidth,
            h:document.documentElement.clientHeight||document.body.clientHeight,
            setw:300,
            seth:300
        }
        var autox=(options.w-options.setw)*0.5,autoy=(options.h-options.seth)*0.5;
        var oCzh=document.getElementById('Mi_drop_canvas');
        var Czh=oCzh.getContext('2d');
        //绘制矩形
        Czh.beginPath();
        Czh.globalAlpha=0.5;
        Czh.fillRect(0,0,options.w,options.h);
        Czh.fill();
        Czh.closePath();
        Czh.beginPath();
        Czh.globalCompositeOperation="destination-out";
        Czh.globalAlpha=1;
        Czh.fillRect(autox,autoy,options.setw,options.seth);
        Czh.fill();
        Czh.closePath();
        Czh.beginPath();
        Czh.globalCompositeOperation='source-over';
        Czh.lineWidth=1;
        Czh.strokeStyle='#ffffff';
        Czh.strokeRect(autox,autoy,options.setw,options.seth);
        Czh.fill();
        Czh.closePath();
	    
        var evt={
            start:{
                x:0,
                y:0,
                bgx:0,
                bgy:0,
                bgsize:[0,0],
                bfb:0.7317554240631163
            }
        }
       
        var content=document.querySelector('#Mi_drop .Mi_drop_content');
        var positi=document.querySelector('#Mi_drop .Mi_drop_bg');
        content.addEventListener('touchstart',touchstart,false)
        content.addEventListener('touchmove',touchmove,false);
        content.addEventListener('touchend',touchend,false)
        function touchstart(ev){
            group(ev);
            getImgzb();
            var event=ev.touches,eventlen=event.length;
            if(eventlen==1){
                evt.start.x=event[0].pageX;
                evt.start.y=event[0].pageY;
            }else if(eventlen==2){
                var ev0X=event[0].pageX,ev1X=event[1].pageX;
                var ev0Y=event[0].pageY,ev1Y=event[1].pageY;
                evt.start.x=Math.abs(ev0X-ev1X);
                evt.start.y=Math.abs(ev0Y-ev1Y);
            }
        }
        function touchmove(ev){
            group(ev);
            var event=ev.touches,eventlen=event.length;
            if(eventlen==1){
                if(evt.boo){
                    evt.start.x=event[0].pageX;
                    evt.start.y=event[0].pageY;
                    evt.boo=false;
                }
                var evX=event[0].pageX,evY=event[0].pageY;
                var calcX=(evX-evt.start.x);
                var calcY=(evY-evt.start.y);
                drags(positi,{
                    style:'backgroundPositionX',
                    calc:evt.start.bgx+calcX,
                    left:autox,
                    right:(-(parseInt(evt.start.bgsize[0])-options.w+autox))
                });
            	drags(positi,{
                    style:'backgroundPositionY',
                    calc:evt.start.bgy+calcY,
                    left:autoy,
                    right:(-(parseInt(evt.start.bgsize[1])-options.h+autoy))
                })
            }else if(eventlen==2){
                if(!evt.boo){ 
                    evt.boo=true;
                }
                var ev0X=event[0].pageX,ev1X=event[1].pageX;
                var ev0Y=event[0].pageY,ev1Y=event[1].pageY;
                var endX=Math.abs(ev0X-ev1X)-evt.start.x,endY=Math.abs(ev0Y-ev1Y)-evt.start.y;
                var num=Math.abs(endX)>Math.abs(endY)?endX:endY;
                positi.style.backgroundSize=parseInt(evt.start.bgsize[0])+num+"px "+(parseInt(evt.start.bgsize[0])+num)/evt.start.bfb+"px";
                drags(positi,{
                    style:'backgroundPositionX',
                    calc:evt.start.bgx-(num/2),
                    left:autox,
                    right:(-(parseInt(evt.start.bgsize[0])+num/2)-options.w+autox)
                });
                drags(positi,{
                    style:'backgroundPositionY',
                    calc:evt.start.bgy-(num/2), 
                    left:autoy,
                    right:(-(parseInt(evt.start.bgsize[1])+num/2)-options.h+autoy)
                }) 
            }
            
        }
        function touchend(ev){
            group(ev);
            getImgzb();
            drags(positi,{
                style:'backgroundPositionX',
                calc:evt.start.bgx,
                left:autox,
                right:(-(parseInt(evt.start.bgsize[0])-options.w+autox))
            });
            drags(positi,{
                style:'backgroundPositionY',
                calc:evt.start.bgy,
                left:autoy,
                right:(-(parseInt(evt.start.bgsize[1])-options.h+autoy))
            })
        }
        function getImgzb(){
            evt.start.bgx=parseFloat(positi.style.backgroundPositionX);
            evt.start.bgy=parseFloat(positi.style.backgroundPositionY);
            evt.start.bgsize=positi.style.backgroundSize.replace(/[a-zA-Z]+/g,'').split(' ');
        }
        function group(ev){
            if(ev.stopPropagation){
                ev.stopPropagation();
            }else{
                window.ev.cancelBubble=true;
            }
        }
        function drags(el,obj){
            if(obj.calc<=obj.left&&obj.calc>=obj.right){
                el.style[obj.style]=obj.calc+'px';
            }else if(obj.calc>=obj.left){
                el.style[obj.style]=obj.left+'px';
            }else if(obj.calc<=obj.right){
                el.style[obj.style]=obj.right+'px';
            }
        }
        var oImage=new Image();
        var file_btn=document.querySelector('#Mi_drop .Mi_drop_btn .Mi_choose');
        var file=document.querySelector('#Mi_drop .Mi_drop_btn .Mi_file');
        var baocun=document.querySelector('#Mi_drop .Mi_drop_btn .Mi_close')
        file_btn.addEventListener('touchstart',function(){
            file.click()
        },false)
        file.addEventListener('change',function(ev){
            ev.preventDefault();
            var files=this.files[0];
            if(('FileReader' in window)){
                var reader=new FileReader();
                reader.onload=function(){
                    var result=reader.result;
                    oImage.src=result;
                };
                oImage.onload=function(){
                	if(oImage.width>options.setw){
                		var beishu=options.setw/oImage.width;
                		console.log(beishu)
                		console.log(oImage.width*beishu)
                		positi.style.cssText="background:url("+oImage.src+");background-size:"+(oImage.width*beishu)+"px "+(oImage.height*beishu)+"px;background-position:"+autox+"px "+autoy+"px;background-repeat: no-repeat;";
                        getImgzb();
                	}
                }
                reader.readAsDataURL(files);
            }
        },false)
        baocun.addEventListener('touchstart',function(){
            if(oImage.src!=''){
                var oC=document.createElement('canvas');
                oC.width=options.setw;oC.height=options.seth;
                var jd=oC.getContext('2d');
                jd.drawImage(oImage,evt.start.bgx-autox,evt.start.bgy-autoy,evt.start.bgsize[0],evt.start.bgsize[1]);
                var base64=oC.toDataURL('image/png',1);
                document.body.innerHTML='<img src="'+base64+'"/>';
            }else{
                alert('请上传一张图片')
            };
        },false)
    }
</script>
</html>
<script>
/*    if(evt.start.bgx+calcX<=autox&&(-(parseFloat(evt.start.bgsize[0])-options.w+autox)<=evt.start.bgx+calcX)){
        positi.style.backgroundPositionX=evt.start.bgx+calcX+'px';
    }else if(evt.start.bgx+calcX>autox){
        positi.style.backgroundPositionX=autox+'px';
    }else if((-(parseFloat(evt.start.bgsize[0])-options.w+autox)>=evt.start.bgx+calcX)){
        positi.style.backgroundPositionX=(-(parseFloat(evt.start.bgsize[0])-options.w+autox))+'px';
    }
 if(evt.start.bgy+calcY<=autoy&&(-(parseFloat(evt.start.bgsize[1])-options.h+autoy))<=evt.start.bgy+calcY){
 positi.style.backgroundPositionY=evt.start.bgy+calcY+'px';
 }else if(evt.start.bgy+calcY>autoy){
 positi.style.backgroundPositionY=autoy+'px';
 }else if((-(parseFloat(evt.start.bgsize[1])-options.h+autoy))>=evt.start.bgy+calcY){
 positi.style.backgroundPositionY=(-(parseFloat(evt.start.bgsize[1])-options.h+autoy))+'px';
 }
*/
</script>
